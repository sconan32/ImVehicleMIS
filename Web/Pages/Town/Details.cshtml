@page
@model Web.Pages.Towns.DetailsModel
@using Microsoft.AspNetCore.Authorization
@using Socona.ImVehicle.Core.Extensions
@inject IAuthorizationService AuthorizationService
@{
    ViewData["Title"] = Html.DisplayFor(model => model.TownItem.Name);
}

<section class="banner_area">
    <div class="container">
        <div class="pull-left">
            <h3><i class="fa fa-map-o"></i>@Html.DisplayFor(model => model.TownItem.Name) </h3>
        </div>
        <div class="pull-right">
            <a asp-page="/Index">主页</a>
            &gt; <a asp-page="/Town/Index">街道</a>
            &gt; <a asp-page="/Town/Details?Id=@Model.TownItem.Id">@Html.DisplayFor(model => model.TownItem.Name) </a>
        </div>
    </div>
</section>
<section class="main_feature_area">
    <div class="container">

        <p>
            @if (await Model.CanEdit())
            {
                <a class="btn btn-new-item" asp-page="../Group/Create" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"><i class="fa fa-plus" aria-hidden="true"></i> 新增安全单位</a>
                <a class="btn btn-new-item" asp-page="../Vehicle/Create" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"><i class="fa fa-plus" aria-hidden="true"></i> 新增车辆</a>
                <a class="btn btn-new-item" asp-page="../Driver/Create" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"><i class="fa fa-plus" aria-hidden="true"></i> 新增驾驶员</a>
                <a class="btn btn-new-item" asp-page="../UserFile/Create" asp-route-townId="@Model.TownItem.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)">
                    <i class="fa fa-plus" aria-hidden="true"></i> 上传文件
                </a>
            }

        </p>
        <hr />
        <br />
        <h4><i class="fa fa-info-circle" aria-hidden="true"></i>基本信息</h4>
        <br />
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>
                        状态
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.TownItem.GroupCount)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.TownItem.VehicleCount)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.TownItem.DriverCount)
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        @(Model.TownItem.IsValid ? "安全" : "预警")
                    </td>
                    <td>
                        @Html.DisplayFor(model => model.TownItem.GroupCount)
                        @if (Model.TownItem.InvalidGroupCount > 0)
                        {
                            <span style="color:darkred">( 预警状态 @Model.TownItem.InvalidGroupCount  )</span>
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(model => model.TownItem.VehicleCount)
                        @if (Model.TownItem.InvalidVehicleCount > 0)
                        {
                            <span style="color:darkred">( 预警状态 @Model.TownItem.InvalidVehicleCount )</span>
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(model => model.TownItem.DriverCount)
                        @if (Model.TownItem.InvalidDriverCount > 0)
                        {
                            <span style="color:darkred">( 预警状态 @Model.TownItem.InvalidDriverCount )</span>
                        }
                    </td>
                </tr>

            </tbody>
        </table>
        <br />
        <hr />

        <br />
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#groups" aria-controls="groups" role="tab" data-toggle="tab"><i class="fa fa-flag-checkered" aria-hidden="true"></i><b>安全单位列表</b></a></li>
            <li role="presentation"><a href="#vehicles" aria-controls="vehicles" role="tab" data-toggle="tab"><i class="fa fa-truck" aria-hidden="true"></i><b>车辆列表</b></a></li>
            <li role="presentation"><a href="#drivers" aria-controls="drivers" role="tab" data-toggle="tab"><i class="fa fa-id-card-o" aria-hidden="true"></i><b>驾驶员列表</b></a></li>
            <li role="presentation"><a href="#userfile" aria-controls="userfile" role="tab" data-toggle="tab"><i class="fa fa-file-archive-o" aria-hidden="true"></i><b>用户文件</b></a></li>
        </ul>
        <div style="border-bottom:1px solid #ddd;border-left:1px solid #ddd;border-right:1px solid #ddd;padding:20px;">

            <!-- Tab panes -->
            <div class="tab-content">

                <div role="tabpanel" class="tab-pane fade in active" id="groups">
                    <br />
                    <h4><i class="fa fa-flag-checkered" aria-hidden="true"></i>安全单位列表</h4>

                    <hr />
                    <table id="Group-table" class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].Code)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].Name)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].Type)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].ChiefName)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].License)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].VehicleCount)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Groups[0].DriverCount)
                                </th>
                                <th width="115"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.TownItem.Groups)
                            {

                                <tr @((!item.IsValid) ? "class=text-danger" : "class=")>


                                    <td>
                                        @Html.DisplayFor(modelItem => item.Code)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Name)
                                        @if (!item.IsValid)
                                        {
                                            <i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i>
                                        }
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Type)
                                    </td>
                                    <td>
                                        <b>@Html.DisplayFor(modelItem => item.ChiefTitle)</b>
                                        @Html.DisplayFor(modelItem => item.ChiefName)
                                        <span style="color:gray"> (@Html.DisplayFor(modelItem => item.ChiefTel))</span>
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.License)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.VehicleCount)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.DriverCount)
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a class="btn btn-view-item btn-sm" asp-page="../Group/Details" asp-route-id="@item.Id"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a>
                                            @if (await Model.CanEdit())
                                            {
                                                <button type="button" class="btn btn-view-item  dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <span class="caret"></span>
                                                    <span class="sr-only">向下弹出</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a asp-page="../Group/Details" asp-route-id="@item.Id"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a></li>
                                                    <li role="separator" class="divider"></li>
                                                    <li><a asp-page="../Group/Edit" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编 辑 </a></li>
                                                    <li><a class="danger" asp-page="../Group/Delete" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                                                </ul>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                            <tr id="Group-loading-mark" hidden>
                                <td colspan="8" align="center">
                                    <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                                    <span class="sr-only">正在加载...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                </div>

                <div role="tabpanel" class="tab-pane fade" id="vehicles">

                    <br />
                    <h4><i class="fa fa-truck" aria-hidden="true"></i>车辆信息列表</h4>
                    <hr />
                    <table id="Vehicle-table" class="table  table-hover">
                        <thead>
                            <tr>


                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].License)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].Usage)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].Brand)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].Type)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].Color)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].YearlyAuditDate)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].InsuranceExpiredDate)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].DriverName)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Vehicles[0].GroupName)
                                </th>




                                <th width="110"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.TownItem.Vehicles)
                            {
                                <tr @((!item.IsValid) ? "class=text-danger" : "class=")>


                                    <td>
                                        @Html.DisplayFor(modelItem => item.License)
                                        @if (!item.IsValid)
                                        {
                                            <i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i>
                                        }
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Usage)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Brand)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Type)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Color)
                                    </td>


                                    <td>
                                        @Html.DisplayFor(modelItem => item.YearlyAuditDate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.InsuranceExpiredDate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.GroupName)

                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a class="btn btn-view-item btn-sm" asp-page="../Vehicle/Details" asp-route-id="@item.Id"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a>
                                            @if (await Model.CanEdit())
                                            {
                                                <button type="button" class="btn btn-view-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <span class="caret"></span>
                                                    <span class="sr-only">向下弹出</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a asp-page="../Vehicle/Details" asp-route-id="@item.Id"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a></li>
                                                    <li role="separator" class="divider"></li>
                                                    <li><a asp-page="../Vehicle/Edit" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编 辑 </a></li>
                                                    <li><a class="danger" asp-page="../Vehicle/Delete" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                                                </ul>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                            <tr id="Vehicle-loading-mark" hidden>
                                <td colspan="8" align="center">
                                    <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                                    <span class="sr-only">正在加载...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>


                </div>
                <div role="tabpanel" class="tab-pane fades" id="drivers">
                    <br />
                    <h4><i class="fa fa-id-card-o" aria-hidden="true"></i>驾驶员列表</h4>

                    <hr />

                    <table id="Driver-table" class="table  table-hover">
                        <thead>
                            <tr>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].Name)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].Gender)
                                </th>


                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].License)
                                </th>




                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].LicenseExpiredDate)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].VehiclesRegistered)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].FirstLicenseIssueDate)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].IdCardNumber)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.TownItem.Drivers[0].Tel)
                                </th>
                                <th width="110"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.TownItem.Drivers)
                            {
                            <tr @((!item.IsValid) ? "class=text-danger" : "class=")>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Name)
                                    @if (!item.IsValid)
                                        {
                                        <i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i>
                                        }
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Gender)
                                </td>


                                <td>
                                    @Html.DisplayFor(modelItem => item.LicenseType)  @Html.DisplayFor(modelItem => item.License)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.LicenseExpiredDate)
                                </td>


                                <td>
                                    @Html.DisplayFor(modelItem => item.VehiclesRegistered)
                                </td>

                                <td>
                                    @Html.DisplayFor(modelItem => item.FirstLicenseIssueDate)
                                </td>

                                <td>
                                    @Html.DisplayFor(modelItem => item.IdCardNumber)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Tel)
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a class="btn btn-view-item btn-sm" asp-page="../Driver/Details" asp-route-id="@item.Id"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a>
                                        @if (await Model.CanEdit())
                                            {
                                            <button type="button" class="btn btn-view-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="caret"></span>
                                                <span class="sr-only">向下弹出</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a asp-page="../Driver/Details" asp-route-id="@item.Id"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a></li>
                                                <li role="separator" class="divider"></li>
                                                <li><a asp-page="../Driver/Edit" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+HttpContext.Request.QueryString)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编 辑 </a></li>
                                                <li><a class="danger" asp-page="../Vehicle/Delete" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                                            </ul>
                                            }
                                    </div>
                                </td>
                            </tr>
                            }
                            <tr id="Driver-loading-mark" hidden>
                                <td colspan="8" align="center">
                                    <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                                    <span class="sr-only">正在加载...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div role="tabpanel" class="tab-pane" id="userfile">
                    <br />
                    <h4><i class="fa fa-file-archive-o" aria-hidden="true"></i>上级文件</h4>

                    <hr />
                    <table class="table">
                        <thead>
                            <tr>


                                <th>
                                    @Html.DisplayNameFor(model => model.GlobalFiles[0].Name)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.GlobalFiles[0].FileName)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.GlobalFiles[0].UploadDate)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.GlobalFiles[0].SizeString)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.GlobalFiles[0].Visibility)
                                </th>
                                <th width="115"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.GlobalFiles)
            {
                                <tr>

                                    <td>
                                         @Html.DisplayFor(modelItem => item.Name)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.FileName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.UploadDate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.SizeString)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Visibility)
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a class="btn btn-view-item btn-sm" asp-page="../UserFile/Download" asp-route-id="@item.Id"><i class="fa fa-download" aria-hidden="true"></i> 下 载</a>



                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <br />
                    <br />
                    <h4><i class="fa fa-file-archive-o" aria-hidden="true"></i>用户文件</h4>

                    <hr />
                    <table class="table">
                        <thead>
                            <tr>


                                <th>
                                    @Html.DisplayNameFor(model => model.UserFiles[0].Name)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.UserFiles[0].FileName)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.UserFiles[0].UploadDate)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.UserFiles[0].SizeString)
                                </th>

                                <th width="115"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.UserFiles)
            {
                                <tr>

                                    <td>
                                    @Html.DisplayFor(modelItem => item.Name)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.FileName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.UploadDate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.SizeString)
                                    </td>

                                    <td>
                                        <div class="btn-group">
                                            <a class="btn btn-view-item btn-sm" asp-page="../UserFile/Download" asp-route-id="@item.Id"><i class="fa fa-download" aria-hidden="true"></i> 下 载</a>
                                            @if (await Model.CanEdit())
                                            {
                                                <button type="button" class="btn btn-view-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <span class="caret"></span>
                                                    <span class="sr-only">向下弹出</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="danger" asp-page="../UserFile/Delete" asp-route-id="@item.Id" asp-route-returnUrl="@Url.GetLocalUrl(Request.Path+Request.QueryString)"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                                                </ul>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>


                </div>

            </div>
        </div>
    </div>
</section>


<script id="DriverRowTmpl" type="text/x-jsrender">
    <tr {{if !isValid}} class="text-danger" {{/if}}>

        <td>
            {{:name}}
            {{if !isValid}}
            <i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i>
            {{/if}}
        </td>
        <td>
            {{genderType:gender}}
        </td>

        <td>
            <span class="label label-warning"><b>{{licenseType:licenseType}}</b></span>&nbsp; {{:license}}
        </td>
        <td>
            {{cnDate:licenseExpiredDate}}
        </td>

        <td>
            {{:vehiclesRegistered}}
        </td>
        <td>
            {{cnDate:firstLicenseIssueDate}}
        </td>
        <td>
            {{:idCardNumber}}
        </td>
        <td>
            {{:tel}}
        </td>
        <td>
            <div class="btn-group">
                <a class="btn btn-view-item btn-sm" href="/Driver/Details?id={{:id}}"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a>
                @if (await Model.CanEdit())
                {
                    <button type="button" class="btn btn-view-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="caret"></span>
                        <span class="sr-only">向下弹出</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a href="/Driver/Details?id={{:id}}"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/Driver/Edit?id={{:id}}&returnUrl=@(Request.Path+Request.QueryString)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编 辑 </a></li>
                        <li><a class="danger" href="/Driver/Delete?id={{:id}}&returnUrl=@(Request.Path+Request.QueryString)"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                    </ul>
                }
            </div>
        </td>
    </tr>

</script>

<script id="GroupRowTmpl" type="text/x-jsrender">
    <tr {{if !isValid}} class="text-danger" {{/if}}>
        <td> {{:code}}          </td>
        <td>
            {{:name}}
            {{if !isValid}}
            <i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i>
            {{/if}}
        </td>
        <td> {{:type}}       </td>
        <td>
            <b>{{:chiefTitle}}</b> {{:chiefName}}
            <span style="color:gray"> ( {{:chiefTel}})</span>
        </td>

        <td> {{:license}}        </td>
        <td> {{:vehicleCount}}   </td>
        <td> {{:driverCount}}    </td>
        <td>
            <div class="btn-group">
                <a class="btn btn-view-item btn-sm" href="/Group/Details?id={{:id}}"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a>
                @if (await Model.CanEdit())
                {
                    <button type="button" class="btn btn-view-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="caret"></span>
                        <span class="sr-only">向下弹出</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a href="/Group/Details?id={{:id}}"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/Group/Edit?id={{:id}}&returnUrl=@(Request.Path+Request.QueryString)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编 辑 </a></li>
                        <li><a href="/Group/Delete?id={{:id}}&returnUrl=@(Request.Path+Request.QueryString)"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                    </ul>
                }
            </div>
        </td>
    </tr>

</script>

<script id="VehicleRowTmpl" type="text/x-jsrender">
    <tr {{if !isValid}} class="text-danger" {{/if}}>

        <td>
            {{:license}}
            {{if !isValid}}
            <i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i>
            {{/if}}

        </td>
        <td>
            {{usageType:usage}}

        </td>
        <td>
            {{:brand}}
        </td>
        <td>
            {{vehicleType:type}}
        </td>

        <td>
            {{:color}}
        </td>

        <td>
            {{cnDate:yearlyAuditDate}}
        </td>

        <td>
            {{cnDate:insuranceExpiredDate}}
        </td>

        <td>
            {{:driverName}}
            <span style="color:gray">{{:driverTel}}</span>
        </td>

        <td>
            {{:groupName}}
        </td>
        <td>
            <div class="btn-group">
                <a class="btn btn-view-item btn-sm" href="/Vehicle/Details?id={{:id}}"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a>
                @if (await Model.CanEdit())
            {
                    <button type="button" class="btn btn-view-item dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="caret"></span>
                        <span class="sr-only">向下弹出</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a href="/Vehicle/Details?id={{:id}}"><i class="fa fa-search-plus" aria-hidden="true"></i> 查 看 </a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/Vehicle/Edit?id={{:id}}&returnUrl=@Request.Path"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编 辑 </a></li>
                        <li><a href="/Vehicle/Delete?id={{:id}}&returnUrl=@Request.Path"> <i class="fa fa-trash-o" aria-hidden="true"></i>删 除 </a></li>

                    </ul>
                }
            </div>
        </td>
    </tr>



</script>
@section Scripts {

    <script type="text/javascript">



        var pageSize = 20;

        var groupMeta = { page: 0, loading: false, completed: false, controller: 'Group', table: $('#Group-table tr:last'), loadmark: $('#Group-loading-mark'), template: $.templates("#GroupRowTmpl"), };
        var vehicleMeta = { page: 0, loading: false, completed: false, controller: 'Vehicle', table: $('#Vehicle-table tr:last'), loadmark: $('#Vehicle-loading-mark'), template: $.templates("#VehicleRowTmpl"), };
        var driverMeta = { page: 0, loading: false, completed: false, controller: 'Driver', table: $('#Driver-table tr:last'), loadmark: $('#Driver-loading-mark'), template: $.templates("#DriverRowTmpl"), };



        $.views.converters({
            cnDate: function (value) {
                if (value == null)
                    return "";
                return (new Date(value)).toLocaleDateString();
            },
            licenseType: function (value) {
                var map = @(Html.EnumToHtmlString<Socona.ImVehicle.Core.Data.VehicleLicenseType>());
                for (var i = 0; i < map.length; i++) {
                    if (map[i].value == value) {
                        return map[i].name;
                    }
                }
            },
            genderType: function (value) {
                var map = @(Html.EnumToHtmlString<Socona.ImVehicle.Core.Data.GenderType>());
                for (var i = 0; i < map.length; i++) {
                    if (map[i].value == value) {
                        return map[i].name;
                    }
                }
            },
             usageType: function (value) {
                var map = @(Html.EnumToHtmlString<Socona.ImVehicle.Core.Data.UsageType>());
                for (var i = 0; i < map.length; i++) {
                    if (map[i].value == value) {
                        return map[i].name;
                    }
                }
            },
            vehicleType: function (value) {
                var map = @(Html.EnumToHtmlString<Socona.ImVehicle.Core.Data.VehicleType>());
                for (var i = 0; i < map.length; i++) {
                    if (map[i].value == value) {
                        return map[i].name;
                    }
                }
            }
        })
        $(document).ready(function () {

            GetData(groupMeta);
            GetData(vehicleMeta);
            GetData(driverMeta);


            $(window).scroll(function () {
                            if ($(window).scrollTop() ==  $(document).height() - $(window).height()) {

                                var meta = GetControllerForActiveTab();
                                if (meta.completed == false && meta.loading==false) {

                                        GetData(meta);
                                }
                            }
                        });
                    });
        function GetControllerForActiveTab()
        {
            var activeTab = $('.nav-tabs .active');
            if (activeTab.text() == "车辆列表") {
                return vehicleMeta;
            }
            else if (activeTab.text() == "驾驶员列表") {
                return driverMeta;
            }
            else if (activeTab.text() == "安全单位列表"){
                return groupMeta;
            }


        }
        function GetData(meta) {
            $.ajax({
                type: 'GET',
                url: '/' + meta.controller + '/LoadData',
                data: { "page": meta.page, "pageSize": pageSize,'townId':@Model.TownItem.Id, },
                dataType: 'json',
                success: function (data) {
                    if (data != null) {
                        if (data.length == 0) {
                            meta.completed = true;
                            return;
                        }

                        for (var i = 0; i < data.length; i++) {
                            var item = data[i];
                            var tmpl = meta.template;
                            var trHtml = tmpl.render(item);
                            meta.table.before(trHtml);

                        }
                        meta.page++;
                    }

                },
                beforeSend: function () {
                    meta.loading = true;
                    meta.loadmark.show();
                },
                complete: function () {
                    meta.loading = false;
                    meta.loadmark.hide();
                },
                error: function () {
                    alert("Error while retrieving data!");
                }
            });
        }
    </script>


}